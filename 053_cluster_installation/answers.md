# 1/8. Prepare both nodes (controlplane and node01) for Kubernetes by completing the following steps:

## 1.1 Apply the necessary sysctl parameters for networking.

https://kubernetes.io/docs/setup/production-environment/container-runtimes/

### Solutions for sysctl parameters for networking (files /etc/modules-load.d/k8s.conf and /etc/sysctl.d/k8s.conf) - only in korean version!

=== BEGIN ===  
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

### 필요한 sysctl 파라미터를 설정하면, 재부팅 후에도 값이 유지된다.
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

### 재부팅하지 않고 sysctl 파라미터 적용하기
sudo sysctl --system  
=== END ===

## 1.2 Install the kubeadm and kubelet packages at the exact version 1.33.0-1.1 on both nodes.

https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

=== BEGIN ===  
sudo apt-get update
### apt-transport-https may be a dummy package; if so, you can skip that package
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

### If the directory `/etc/apt/keyrings` does not exist, it should be created before the curl command, read the note below.
### sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

### This overwrites any existing configuration in /etc/apt/sources.list.d/kubernetes.list
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update

sudo apt-get install -y kubelet=1.33.0-1.1 kubeadm=1.33.0-1.1 
sudo apt-mark hold kubelet kubeadm
  
=== END ===

## 1.3 Install the kubectl package at the exact version 1.33.0-1.1 exclusively on the controlplane.

https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

### Next - only for Controlplane! 
sudo apt-get install -y kubectl=1.33.0-1.1 
sudo apt-mark hold kubectl

# 2/8. What is the version of kubelet installed?

kubelet --version

# 3/8. How many nodes are part of kubernetes cluster currently?

kubectl get nodes

# 4/8. Let's now bootstrap a kubernetes cluster using kubeadm, configuring custom networking for pods and services, optimizing API server exposure, and overall cluster functionality. The latest version of Kubernetes will be installed.

=== NO QUESTION ===

# 5/8. Initialize Control Plane Node (Master Node). Use the following options:

apiserver-advertise-address - Use the IP address allocated to eth0 on the controlplane node

apiserver-cert-extra-sans - Set it to controlplane

pod-network-cidr - Set to 172.17.0.0/16

service-cidr - Set to 172.20.0.0/16

Once done, set up the default kubeconfig file and wait for node to be part of the cluster.

https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/
### Attention! Command "ip a" for a variable "--apiserver-advertise-address 192.168.104.42"

=== BEGIN ===
sudo kubeadm init --apiserver-advertise-address 192.168.104.42 --apiserver-cert-extra-sans controlplane --pod-network-cidr 172.17.0.0/16 --service-cidr 172.20.0.0/16

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
=== END ===

# 6/8. Generate a kubeadm join token. Or copy the one that was generated by kubeadm init command.

https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/

## 7/8. Join node01 to the cluster using the join token

### Only for Controlplane!
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

### Option 1. Simple copy from Controlplane and run on Node01
sudo kubeadm join 192.168.104.42:6443 --token j7bn4o.xfgb3gw8edfvybnw \
        --discovery-token-ca-cert-hash sha256:26ee09155c6e412b21e1da473a18ff2d661eeb7e03eb52489fb0ecc82a501d83 

### Option 2.
https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/
https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/

=== BEGIN ===
kubeadm token create

openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'

### For port
cat /etc/kubernetes/manifests/kube-apiserver.yaml  | grep port

### Attention! 3 (three!) variables!
sudo kubeadm join --discovery-token abcdef.1234567890abcdef --discovery-token-ca-cert-hash sha256:1234..cdef 1.2.3.4:6443
=== END ===

# 8/8.
